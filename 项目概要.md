# 项目概要（CSDI）

## 项目简介

本项目为 NeurIPS 2021 论文 **“CSDI: Conditional Score-based Diffusion Models for Probabilistic Time Series Imputation”** 的代码实现，核心目标是对**时间序列缺失值进行概率式插补**（同时可做 forecasting 形式的预测/补全）。

- **核心方法**：条件化的 score-based diffusion（扩散生成）模型；使用时间/特征嵌入与注意力模块建模时序与变量维度。
- **主要任务**：
  - **PhysioNet 2012（healthcare）**：插补（可训练/可用预训练权重推理）
  - **PM2.5（airquality）**：插补
  - **Electricity（forecasting）**：forecasting 设定（历史 + 未来预测区间）

> 注意：根据你的要求，项目相关操作应在 `conda activate csdi` 环境下进行，避免在 `base` 环境直接执行安装/运行。

## 快速开始（高层）

### 1) 环境

- 建议 Python 3.8（最低 3.7+）
- 依赖见 `requirements.txt`
- 可运行 `python test_environment.py` 检查依赖与 CUDA 可用性（如有 GPU）

### 2) 数据准备

- **healthcare（physio）**：
  - `python download.py physio`
  - 期望数据路径：`data/physio/set-a/*.txt`
- **airquality（pm25）**：
  - `python download.py pm25`
  - 期望数据路径：`data/pm25/...`，并生成 `data/pm25/pm25_meanstd.pk`
- **electricity（forecasting）**：
  - 按 `README.md` 提示将 Google Drive 中的 electricity 文件放到 `data/` 下
  - 期望数据路径：`data/electricity_nips/data.pkl` 与 `data/electricity_nips/meanstd.pkl`

### 3) 训练/插补/预测入口

- **PhysioNet 2012（训练 + 插补）**：
  - `python exe_physio.py --testmissingratio <缺失比例> --nsample <采样数>`
  - 使用预训练：`python exe_physio.py --modelfolder pretrained --testmissingratio <缺失比例> --nsample <采样数>`
- **PM2.5（训练 + 插补）**：
  - `python exe_pm25.py --nsample <采样数>`
- **Electricity（forecasting）**：
  - `python exe_forecasting.py --datatype electricity --nsample <采样数>`

### 4) 输出（save 目录）

各入口脚本会创建类似 `save/<task>_<timestamp>/` 的目录，常见文件包括：

- `config.json`：本次运行使用的完整配置（从 YAML 读取并融合 CLI 参数）
- `model.pth`：训练后保存的权重（若进行了训练）
- `generated_outputs_nsample*.pk`：评估阶段保存的采样结果与中间量（用于可视化/复现）
- `result_nsample*.pk`：RMSE/MAE/CRPS 等指标结果

## 目录结构与文件用途说明

> 说明：仓库中还包含 `.git/` 下的大量 Git 内部文件（用于版本管理），通常无需逐一理解，这里只对项目核心代码与配置文件做用途概括。

### `config/`

- `config/base.yaml`：通用任务（如 physio/pm25）的训练参数、扩散参数、模型参数默认值。
- `config/base_forecasting.yaml`：forecasting 任务（electricity）使用的配置变体（如 `is_linear`、`target_strategy`、`num_sample_features` 等）。

### `data/`

- `data/.gitkeep`：占位文件，用于确保空的 `data/` 目录能被 Git 跟踪；真实数据需按任务下载/放置到该目录下。

### `save/`

- `save/pretrained/model.pth`：项目提供的**预训练模型权重**（用于 `exe_physio.py --modelfolder pretrained` 等场景）。

### 根目录脚本与模块

- `README.md`：项目官方说明（数据下载方式、实验命令、引用信息等）。
- `环境配置指南.md`：中文环境配置说明（conda 环境、推荐 Python 版本、依赖安装与验证建议）。
- `requirements.txt`：Python 依赖列表（torch/pandas/numpy/tqdm/pyyaml/matplotlib/wget/requests/linear_attention_transformer 等）。
- `LICENSE`：MIT License。

#### 入口脚本（命令行运行）

- `exe_physio.py`：PhysioNet 2012 任务的训练与插补入口；读取配置，构建 dataloader 与 `CSDI_Physio`，训练或加载权重后调用 `utils.evaluate`。
- `exe_pm25.py`：PM2.5 任务的训练与插补入口；构建 dataloader 与 `CSDI_PM25`，训练/加载后评估与保存结果。
- `exe_forecasting.py`：Electricity forecasting 入口；构建 dataloader 与 `CSDI_Forecasting`，训练/加载后评估与保存结果。
- `download.py`：数据下载脚本（`physio` 从 PhysioNet 下载 tar.gz 并解压；`pm25` 下载 zip 并解压，同时计算并保存 `pm25_meanstd.pk`）。
- `test_environment.py`：环境自检脚本；检查 Python 版本、核心依赖包、CUDA 可用性、以及 `linear_attention_transformer` 是否可导入。

#### 数据集构建

- `dataset_physio.py`：PhysioNet 2012 数据读取与预处理；生成观测值/观测 mask/gt mask，做归一化并缓存到 `data/physio_missing*.pk`；提供 `get_dataloader`（含 5-fold 划分）。
- `dataset_pm25.py`：PM2.5 数据读取与划分（train/valid/test 月份切分）；构建观测/gt/hist mask（用于 mix/historical 策略），并提供 `get_dataloader` 输出 scaler/mean_scaler。
- `dataset_forecasting.py`：Electricity forecasting 数据集；从 `data/electricity_nips/*.pkl` 读取并标准化，按 train/valid/test 进行滑窗采样；提供 `get_dataloader` 输出 scaler/mean_scaler。

#### 模型与扩散实现

- `main_model.py`：
  - 定义 `CSDI_base`：时间/特征 embedding、mask 策略（random / mix / historical / test-pattern）、扩散训练 loss（噪声预测）、以及反向扩散采样（impute）。
  - 定义任务子类：`CSDI_Physio` / `CSDI_PM25` / `CSDI_Forecasting`，负责把 batch 处理成统一的张量布局，并在 forecasting 下做特征子采样等逻辑。
- `diff_models.py`：
  - 定义 `diff_CSDI` 主网络：输入投影 + 多层 `ResidualBlock`，输出噪声预测。
  - `ResidualBlock` 内含 time-wise 与 feature-wise 注意力（可选 PyTorch Transformer 或 `linear_attention_transformer` 线性注意力版本），并融合条件信息（side info）。

#### 训练与评估

- `utils.py`：
  - `train(...)`：标准训练循环（Adam + MultiStepLR；可选 valid 评估；保存 `model.pth`）。
  - `evaluate(...)`：采样评估、计算 RMSE/MAE，并计算分位数 CRPS；保存生成样本与指标到 `save/<run>/`。

#### 可视化

- `visualize_examples.ipynb`：读取 `save/<folder>/generated_outputs_nsample*.pk`，对 healthcare / airquality 示例进行分位数带状图可视化（例如 5%~95% 区间）。

### 开发工具配置（可忽略）

- `.vscode/settings.json`：VSCode 的 Python/Conda 环境管理偏好设置。
###


